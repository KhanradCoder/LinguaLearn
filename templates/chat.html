{% extends "layout.html" %}
{% block title %}{{ lang_title }}{% endblock %}
{% block content %}
<h1 align="center"><b>LinguaLearn - {{ lang_title }}</b></h1>
<br><br>
<div class="boxed">
  <div id="chatbox">
    <p class="botText">
    <span>{{ intro_message }}</span>
    </p>
  </div>
  <div id="userInput">
      <input align="center" id="textInput" class="form-control" type="text" name="msg" placeholder="{{ placeholder }}" /><br>
      <img id="recordButton" src="static/img/record.svg" height="64px" width="64px" onclick="toggleRecording()">
  </div>
</div>
<script>
var isRecording = false;
var recognition;
const lang = '{{ lang_code }}';

$("#textInput").keydown(function (e) {
  console.log(e);
  if (e.key == 'Enter') {
    getBotResponse();
  }
});

function toggleRecording() {
  var recordButton = document.getElementById('recordButton');
  if (!isRecording) {
    if (window.hasOwnProperty('webkitSpeechRecognition')) {
      recognition = new webkitSpeechRecognition();

      recognition.continuous = true;
      recognition.interimResults = false;

      recognition.lang = lang;
      recognition.start();

      recognition.onresult = function (e) {
        document.getElementById('textInput').value += e.results[0][0].transcript + ' ';
        recognition.stop();
      };

      recognition.onerror = function (e) {
        console.log('error', e);
        recognition.stop();
      };

      //keeps recording until button pressed
      recognition.onend = function (e) {
        console.log('ended', e);
        if (isRecording){
          recognition.start();
        }
      };
    }
    recordButton.src = 'static/img/stop.svg';
    isRecording = true;
  }
  else {
    recordButton.src = 'static/img/record.svg';
    recognition.stop();
    isRecording = false;
    getBotResponse();
  }
};

function getBotResponse() {
  var rawText = $("#textInput").val();
  var userHtml = '<p class="userText"><span>' + rawText + "</span></p>";
  $("#textInput").val("");
  $("#chatbox").append(userHtml);
  document
    .getElementById("userInput")
    .scrollIntoView({ block: "start", behavior: "smooth" });
  $.get("/get", { msg: rawText }).done(function (data) {
    var botHtml = '<p class="botText"><span>' + data + '</span></p>';
    $("#chatbox").append(botHtml);
    document
      .getElementById("userInput")
      .scrollIntoView({ block: "start", behavior: "smooth" });
      var speech = new SpeechSynthesisUtterance(data);
      speech.lang = lang;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(speech);
      
      // prevents tts from cutting off
      let r = setInterval(() => {
        console.log(speechSynthesis.speaking);
        if (!speechSynthesis.speaking) {
          clearInterval(r);
        } else {
          speechSynthesis.pause();
          speechSynthesis.resume();
        }
      }, 14000);
  });
}
</script>
{% endblock %}